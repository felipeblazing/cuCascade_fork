name: ci

on:
  push:
    branches:
      - "main"
      - "pull-request/[0-9]+"

jobs:
  build:
    runs-on: linux-amd64-cpu4
    env:
      SCCACHE_GHA_ENABLED: true

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: prefix-dev/setup-pixi@82d477f15f3a381dbcc8adc1206ce643fe110fb7 # v0.9.3
        with:
          cache: false

      - uses: mozilla-actions/sccache-action@7d986dd989559c6ecdb630a3fd2557667be217ad # v0.0.9

      - run: pixi run build

      - name: Stop sccache
        if: always()
        run: sccache --stop-server || true

      - name: Package build artifacts
        run: tar -cf build-release.tar build/release/

      - name: Upload build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: build-release
          path: build-release.tar
          if-no-files-found: error
          retention-days: 1

  test:
    needs: build
    runs-on: linux-amd64-gpu-t4-latest-1

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: prefix-dev/setup-pixi@82d477f15f3a381dbcc8adc1206ce643fe110fb7 # v0.9.3
        with:
          cache: false

      - name: Download build artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-release

      - name: Extract build artifacts
        run: tar -xf build-release.tar

      - run: pixi run test

  benchmark:
    needs: build
    runs-on: linux-amd64-gpu-t4-latest-1

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: prefix-dev/setup-pixi@82d477f15f3a381dbcc8adc1206ce643fe110fb7 # v0.9.3
        with:
          cache: false

      - name: Download build artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-release

      - name: Extract build artifacts
        run: tar -xf build-release.tar

      - name: Run benchmarks
        working-directory: build/release/benchmark/
        run: |
          ./cucascade_benchmarks \
            --benchmark_filter=Convert \
            --benchmark_out_format=json \
            --benchmark_out=${{ github.workspace }}/benchmark_result.json \
            --benchmark_min_time=2.0s

      - name: Restore baseline benchmark data
        uses: actions/cache/restore@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        id: benchmark-data
        with:
          key: benchmark_result-linux-amd64-gpu-t4-latest-1-v1
          path: .cache/benchmark_result.json

      - name: Compare benchmark results
        uses: benchmark-action/github-action-benchmark@4bdcce38c94cec68da58d012ac24b7b1155efe8b # v1.20.7
        with:
          tool: googlecpp
          output-file-path: ${{ github.workspace }}/benchmark_result.json
          github-token: ${{ github.token }}
          external-data-json-path: .cache/benchmark_result.json
          summary-always: true
          comment-on-alert: true
          alert-threshold: "120%"

      - name: Save baseline benchmark data
        uses: actions/cache/save@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        if: ${{ github.event_name == 'push' && github.ref_name == 'main' }}
        with:
          key: ${{ steps.benchmark-data.outputs.cache-primary-key }}
          path: .cache/benchmark_result.json
